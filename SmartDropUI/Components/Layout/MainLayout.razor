@inherits LayoutComponentBase
@using SmartDropUI.Services
@using SmartDropUI.Models
@using System.Timers
@inject ArduinoService ArduinoService
@inject HistorialRiegoService HistorialService
@inject ApiService ApiService
@inject AuthService AuthService
@inject ClimaService ClimaService

<div class="page">
    <main style="width: 100%; height: 100vh; overflow-y: auto;">
        @Body
    </main>
</div>

@code {
    private Timer? _timerGlobal;
    private bool bombaFueEncendida = false;
    private List<PlantaModel> misPlantas = new();

    // ✅ VARIABLES ANTI-DUPLICADOS
    private DateTime _ultimoGuardado = DateTime.MinValue;
    private bool _estaGuardando = false; // Semáforo para evitar colisiones

    protected override async Task OnInitializedAsync()
    {
        _timerGlobal = new Timer(2000);
        _timerGlobal.Elapsed += async (s, e) => await MonitorearRiego();
        _timerGlobal.AutoReset = true;
        _timerGlobal.Start();

        await CargarPlantasCache();
    }

    private async Task CargarPlantasCache()
    {
        try
        {
            var usuario = await AuthService.GetUsuarioActualAsync();
            if (usuario != null)
            {
                var resultado = await ApiService.ObtenerPlantasPorUsuarioAsync(usuario.IdUsuario);
                if (resultado != null) misPlantas = resultado;
            }
        }
        catch { }
    }

    private async Task MonitorearRiego()
    {
        try
        {
            var estado = await ArduinoService.ObtenerEstadoAsync();

            if (estado != null)
            {
                // DETECCIÓN: Si la bomba se enciende (OFF -> ON)
                if (!bombaFueEncendida && estado.BombaEncendida)
                {
                    // ✅ LÓGICA ROBUSTA ANTI-DUPLICADOS
                    // 1. Verificamos si ya estamos guardando algo (_estaGuardando)
                    // 2. Verificamos si pasaron al menos 60 segundos desde el último guardado
                    double segundosDesdeUltimo = (DateTime.Now - _ultimoGuardado).TotalSeconds;

                    if (!_estaGuardando && segundosDesdeUltimo > 60)
                    {
                        _estaGuardando = true; // 🔒 BLOQUEAMOS INMEDIATAMENTE

                        Console.WriteLine("🌍 [GLOBAL] Riego Detectado. Iniciando proceso de guardado único...");

                        // Ejecutamos el guardado
                        await RegistrarRiegoGlobal(estado.Humedad);

                        _ultimoGuardado = DateTime.Now; // Actualizamos la hora
                        _estaGuardando = false; // 🔓 DESBLOQUEAMOS
                    }
                    else
                    {
                        // Console.WriteLine("⏳ Riego ignorado (Ya se está guardando o fue muy reciente).");
                    }
                }

                // Actualizar estado anterior
                bombaFueEncendida = estado.BombaEncendida;
            }
        }
        catch
        {
            _estaGuardando = false; // Liberar en caso de error
        }
    }

    private async Task RegistrarRiegoGlobal(int humedadSuelo)
    {
        try
        {
            // Asegurar plantas
            if (misPlantas == null || !misPlantas.Any()) await CargarPlantasCache();

            int idPlanta = (misPlantas != null && misPlantas.Any()) ? misPlantas.First().IdPlanta : 0;
            if (idPlanta == 0) return;

            // Obtener Clima
            float temp = 25.0f;
            float humAire = 50.0f;
            float viento = 0.0f;
            try
            {
                var clima = await ClimaService.ObtenerClimaActualAsync();
                if (clima != null)
                {
                    temp = (float)clima.Temperatura;
                    humAire = (float)clima.Humedad;
                    viento = (float)clima.VelocidadViento;
                }
            }
            catch { }

            // 1. Guardar Historial
            var historial = new HistorialRiegoModel
            {
                Fecha = DateTime.Now,
                Humedad = humedadSuelo,
                Temperatura = temp,
                IdPlanta = idPlanta
            };
            await HistorialService.GuardarRiegoAsync(historial);

            // 2. Guardar Tablas Auxiliares
            await ApiService.GuardarTemperaturaAsync(temp, temp, "Riego Automático Global", idPlanta);
            await ApiService.GuardarRegistroClimaticoAsync(humedadSuelo, humAire, temp, viento, idPlanta);

            Console.WriteLine("✅ [BD] Registro guardado correctamente.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ [GLOBAL] Error: {ex.Message}");
        }
    }

    public void Dispose()
    {
        _timerGlobal?.Stop();
        _timerGlobal?.Dispose();
    }
}