@inherits LayoutComponentBase
@using SmartDropUI.Services
@using SmartDropUI.Models
@using System.Timers
@inject ArduinoService ArduinoService
@inject HistorialRiegoService HistorialService
@inject ApiService ApiService
@inject AuthService AuthService
@inject ClimaService ClimaService
@inject IJSRuntime JS

<div class="page">
    <main style="width: 100%; height: 100vh; overflow-y: auto;">
        @Body
    </main>
</div>

@code {
    private Timer? _timerGlobal;

    // ✅ LÓGICA DE CICLO:
    // true = Ya guardé este riego, no guardar más hasta que se apague.
    // false = Estoy listo para guardar el próximo riego.
    private bool _yaRegistreEsteCiclo = false;
    private bool _guardando = false;

    protected override async Task OnInitializedAsync()
    {
        // Timer rápido (1 segundo)
        _timerGlobal = new Timer(1000);
        _timerGlobal.AutoReset = false;
        _timerGlobal.Elapsed += async (s, e) => await MonitorearRiegoAutomatico();
        _timerGlobal.Start();
    }

    private async Task MonitorearRiegoAutomatico()
    {
        try
        {
            var estado = await ArduinoService.ObtenerEstadoAsync();

            if (estado != null)
            {
                // --- CASO 1: LA BOMBA ESTÁ APAGADA ---
                if (!estado.BombaEncendida)
                {
                    // Reiniciamos la bandera para estar listos para el próximo riego
                    if (_yaRegistreEsteCiclo)
                    {
                        _yaRegistreEsteCiclo = false;
                        Console.WriteLine("🔄 [SISTEMA] Bomba apagada. Sistema listo para próximo registro.");
                    }
                }
                // --- CASO 2: LA BOMBA ESTÁ ENCENDIDA ---
                else
                {
                    // Verificamos que sea Automático (Usuario no está presionando botón)
                    // Y que NO hayamos registrado este ciclo todavía
                    if (!EstadoGlobal.UsuarioEstaRegando && !_yaRegistreEsteCiclo && !_guardando)
                    {
                        _guardando = true;

                        await JS.InvokeVoidAsync("console.log", $"⚡ [AUTO] ¡Riego detectado! Guardando en Historial...");

                        // Guardamos
                        bool exito = await RegistrarRiegoBaseDatos(estado.Humedad);

                        if (exito)
                        {
                            // ✅ MARCAMOS QUE YA SE REGISTRÓ ESTE CICLO
                            _yaRegistreEsteCiclo = true;
                        }

                        _guardando = false;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error monitor: {ex.Message}");
            _guardando = false;
        }
        finally
        {
            _timerGlobal?.Start();
        }
    }

    private async Task<bool> RegistrarRiegoBaseDatos(float humedadSuelo)
    {
        try
        {
            // 1. BUSCAR PLANTA (Cualquiera disponible como respaldo)
            int idPlantaDestino = 0;
            string nombrePlanta = "Riego Automático";

            // Intentar obtener todas las plantas
            var todasLasPlantas = await ApiService.ObtenerPlantasAsync();

            if (todasLasPlantas != null && todasLasPlantas.Any())
            {
                // Usamos la primera planta encontrada
                var p = todasLasPlantas.First();
                idPlantaDestino = p.IdPlanta;
                nombrePlanta = p.NombrePlanta;
            }
            else
            {
                await JS.InvokeVoidAsync("console.warn", "❌ [AUTO] Error: No hay plantas en la BD.");
                return false;
            }

            // 2. CLIMA
            float temp = 25.0f;
            float humAire = 50.0f;
            float viento = 0.0f;
            try
            {
                var clima = await ClimaService.ObtenerClimaActualAsync();
                if (clima != null)
                {
                    temp = (float)clima.Temperatura;
                    humAire = (float)clima.Humedad;
                    viento = (float)clima.VelocidadViento;
                }
            }
            catch { }

            // 3. GUARDAR EN BD
            var historial = new HistorialRiegoModel
            {
                Fecha = DateTime.Now,
                Humedad = humedadSuelo,
                Temperatura = temp,
                IdPlanta = idPlantaDestino,
                NombrePlanta = nombrePlanta,
                TipoRiego = "Automatico" // Sin tilde
            };

            bool exito = await HistorialService.GuardarRiegoAsync(historial);

            if (exito)
            {
                await ApiService.GuardarTemperaturaAsync(temp, temp, "Riego Auto", idPlantaDestino);
                await ApiService.GuardarRegistroClimaticoAsync(humedadSuelo, humAire, temp, viento, idPlantaDestino);
                await JS.InvokeVoidAsync("console.log", "✅ [AUTO] Registro guardado exitosamente.");
                return true;
            }
            else
            {
                await JS.InvokeVoidAsync("console.error", "❌ [AUTO] La API rechazó el guardado.");
                return false;
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"❌ [AUTO] Excepción: {ex.Message}");
            return false;
        }
    }

    public void Dispose()
    {
        _timerGlobal?.Stop();
        _timerGlobal?.Dispose();
    }
}