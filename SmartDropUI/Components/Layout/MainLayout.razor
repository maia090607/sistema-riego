@inherits LayoutComponentBase
@using SmartDropUI.Services
@using SmartDropUI.Models
@using System.Timers
@inject ArduinoService ArduinoService
@inject HistorialRiegoService HistorialService
@inject ApiService ApiService
@inject AuthService AuthService
@inject ClimaService ClimaService

<div class="page">
    <main style="width: 100%; height: 100vh; overflow-y: auto;">
        @Body
    </main>
</div>

@code {
    private Timer? _timerGlobal;
    private bool _bombaAnteriormenteEncendida = false;

    // Variables locales para control rápido
    private DateTime _ultimoGuardadoLocal = DateTime.MinValue;
    private bool _guardando = false;

    protected override async Task OnInitializedAsync()
    {
        _timerGlobal = new Timer(2000);
        _timerGlobal.AutoReset = false; // Pausa el timer mientras trabaja para evitar solapamientos
        _timerGlobal.Elapsed += async (s, e) => await MonitorearRiegoAutomatico();
        _timerGlobal.Start();
    }

    private async Task MonitorearRiegoAutomatico()
    {
        try
        {
            var estado = await ArduinoService.ObtenerEstadoAsync();

            if (estado != null)
            {
                // Detectar si la bomba está encendida en modo automático
                if (estado.BombaEncendida && !estado.ModoManual)
                {
                    // Condición 1: Flanco de subida (Estaba apagada -> Ahora encendida)
                    // Condición 2: O si ya estaba encendida, asegurarnos por tiempo (Safety check)
                    bool flancoSubida = !_bombaAnteriormenteEncendida;
                    bool tiempoSuficienteLocal = (DateTime.Now - _ultimoGuardadoLocal).TotalSeconds > 120;

                    if ((flancoSubida || tiempoSuficienteLocal) && !_guardando)
                    {
                        _guardando = true;
                        await RegistrarRiegoBaseDatos(estado.Humedad);
                        _guardando = false;
                    }
                }

                _bombaAnteriormenteEncendida = estado.BombaEncendida;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"⚠️ Error monitor: {ex.Message}");
            _guardando = false;
        }
        finally
        {
            _timerGlobal?.Start(); // Reiniciar timer
        }
    }

    private async Task RegistrarRiegoBaseDatos(float humedadSuelo)
    {
        try
        {
            // 🛑 VALIDACIÓN CRÍTICA DE BASE DE DATOS (SOLUCIÓN AL PROBLEMA)
            // Antes de guardar, verificamos qué hay en la base de datos.
            // Esto sincroniza todas las pestañas abiertas: si una ya guardó, las otras se detienen.
            var ultimoEnBd = await HistorialService.ObtenerUltimoRiegoAsync();

            if (ultimoEnBd != null)
            {
                // Si el último registro en BD es de hace menos de 2 minutos (120 seg), ABORTAMOS.
                double segundosDesdeUltimo = (DateTime.Now - ultimoEnBd.Fecha).TotalSeconds;
                if (segundosDesdeUltimo < 120)
                {
                    Console.WriteLine($"🛡️ [AUTO] Registro bloqueado. Ya existe uno reciente ({segundosDesdeUltimo:F0}s atrás).");
                    _ultimoGuardadoLocal = DateTime.Now; // Sincronizamos localmente
                    return;
                }
            }

            Console.WriteLine("💧 [AUTO] Guardando nuevo registro de riego...");

            // --- 1. OBTENER PLANTA (FALLBACK ROBUSTO) ---
            int idPlantaDestino = 0;
            string nombrePlanta = "Automático";

            try
            {
                var usuario = await AuthService.GetUsuarioActualAsync();
                if (usuario != null)
                {
                    var misPlantas = await ApiService.ObtenerPlantasPorUsuarioAsync(usuario.IdUsuario);
                    if (misPlantas != null && misPlantas.Any())
                    {
                        idPlantaDestino = misPlantas.First().IdPlanta;
                        nombrePlanta = misPlantas.First().NombrePlanta;
                    }
                }
            }
            catch { }

            // Si no hay usuario o planta, buscar la primera del sistema (Respaldo)
            if (idPlantaDestino == 0)
            {
                var todas = await ApiService.ObtenerPlantasAsync();
                if (todas != null && todas.Any())
                {
                    idPlantaDestino = todas.First().IdPlanta;
                    nombrePlanta = todas.First().NombrePlanta;
                }
            }

            if (idPlantaDestino == 0) return; // No se puede guardar sin ID

            // --- 2. OBTENER CLIMA ---
            float temp = 25.0f;
            float humAire = 50.0f;
            float viento = 0.0f;
            try
            {
                var clima = await ClimaService.ObtenerClimaActualAsync();
                if (clima != null)
                {
                    temp = (float)clima.Temperatura;
                    humAire = (float)clima.Humedad;
                    viento = (float)clima.VelocidadViento;
                }
            }
            catch { }

            // --- 3. GUARDAR ---
            var historial = new HistorialRiegoModel
            {
                Fecha = DateTime.Now,
                Humedad = humedadSuelo,
                Temperatura = temp,
                IdPlanta = idPlantaDestino,
                NombrePlanta = nombrePlanta
            };

            bool exito = await HistorialService.GuardarRiegoAsync(historial);

            if (exito)
            {
                _ultimoGuardadoLocal = DateTime.Now; // Actualizar contador local

                await ApiService.GuardarTemperaturaAsync(temp, temp, "Riego Automático", idPlantaDestino);
                await ApiService.GuardarRegistroClimaticoAsync(humedadSuelo, humAire, temp, viento, idPlantaDestino);
                Console.WriteLine($"✅ [AUTO] Guardado exitoso.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ [AUTO] Error al guardar: {ex.Message}");
        }
    }

    public void Dispose()
    {
        _timerGlobal?.Stop();
        _timerGlobal?.Dispose();
    }
}