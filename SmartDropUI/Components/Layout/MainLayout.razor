@inherits LayoutComponentBase
@using SmartDropUI.Services
@using SmartDropUI.Models
@using System.Timers
@inject ArduinoService ArduinoService
@inject HistorialRiegoService HistorialService
@inject ApiService ApiService
@inject AuthService AuthService
@inject ClimaService ClimaService
@inject IJSRuntime JS

<div class="page">
    <main style="width: 100%; height: 100vh; overflow-y: auto;">
        @Body
    </main>
</div>

@code {
    private Timer? _timerGlobal;

    // Variables para controlar el guardado y evitar duplicados
    private DateTime _ultimoGuardadoAuto = DateTime.MinValue;
    private bool _procesandoGuardado = false;
    private bool _bombaEstabaEncendida = false;

    protected override async Task OnInitializedAsync()
    {
        // Timer ejecutándose cada 1.5 segundos
        _timerGlobal = new Timer(1500);
        _timerGlobal.AutoReset = false;
        _timerGlobal.Elapsed += async (s, e) => await MonitorearRiegoAutomatico();
        _timerGlobal.Start();
    }

    private async Task MonitorearRiegoAutomatico()
    {
        try
        {
            // 1. Consultar estado al Arduino (Hardware)
            var estado = await ArduinoService.ObtenerEstadoAsync();

            if (estado != null)
            {
                // 2. LÓGICA DE DETECCIÓN:
                // - Bomba ENCENDIDA
                // - Modo Manual APAGADO (Esto confirma que fue el Arduino quien decidió regar)
                if (estado.BombaEncendida && !estado.ModoManual)
                {
                    // 3. Verificamos si es un evento nuevo o si ya pasó el tiempo de espera (45s)
                    // Esto evita que se guarde 10 veces el mismo riego
                    bool esNuevoEvento = !_bombaEstabaEncendida;
                    double segundosDesdeUltimo = (DateTime.Now - _ultimoGuardadoAuto).TotalSeconds;

                    if ((esNuevoEvento || segundosDesdeUltimo > 45) && !_procesandoGuardado)
                    {
                        _procesandoGuardado = true;
                        _ultimoGuardadoAuto = DateTime.Now; // Bloqueo inmediato

                        await JS.InvokeVoidAsync("console.log", $"⚡ [AUTO] ¡Riego Automático Detectado! (Humedad: {estado.Humedad}%). Guardando...");

                        // Llamamos al guardado
                        await RegistrarRiegoBaseDatos(estado.Humedad);

                        _procesandoGuardado = false;
                    }
                }

                // Guardar estado para comparar en la siguiente vuelta del timer
                _bombaEstabaEncendida = estado.BombaEncendida;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error en monitor de riego: {ex.Message}");
            _procesandoGuardado = false;
        }
        finally
        {
            _timerGlobal?.Start(); // Reactivar el timer
        }
    }

    private async Task RegistrarRiegoBaseDatos(float humedadSuelo)
    {
        try
        {
            // --- 1. SELECCIÓN DE PLANTA (MODO ROBUSTO) ---
            // No dependemos del usuario logueado (puede fallar en segundo plano).
            // Buscamos cualquier planta válida en la BD.

            int idPlantaDestino = 1; // ID por defecto de emergencia
            string nombrePlanta = "Riego Automático";

            try
            {
                var todasLasPlantas = await ApiService.ObtenerPlantasAsync();
                if (todasLasPlantas != null && todasLasPlantas.Any())
                {
                    // Tomamos la primera planta real que encontremos
                    var p = todasLasPlantas.First();
                    idPlantaDestino = p.IdPlanta;
                    nombrePlanta = p.NombrePlanta;
                }
            }
            catch
            {
                // Si falla la API de plantas, usamos el ID 1 y seguimos adelante
                Console.WriteLine("⚠️ [AUTO] No se pudieron cargar plantas. Usando ID 1 por defecto.");
            }

            // --- 2. OBTENER CLIMA (OPCIONAL) ---
            float temp = 28.0f; // Valores por defecto si falla el clima
            float humAire = 50.0f;
            float viento = 2.0f;

            try
            {
                var clima = await ClimaService.ObtenerClimaActualAsync();
                if (clima != null)
                {
                    temp = (float)clima.Temperatura;
                    humAire = (float)clima.Humedad;
                    viento = (float)clima.VelocidadViento;
                }
            }
            catch { }

            // --- 3. GUARDAR EN BASE DE DATOS ---
            var historial = new HistorialRiegoModel
            {
                Fecha = DateTime.Now,
                Humedad = humedadSuelo,
                Temperatura = temp,
                IdPlanta = idPlantaDestino,
                NombrePlanta = nombrePlanta,
                TipoRiego = "Automatico" // ✅ SIN TILDE Y TEXTO FIJO
            };

            // Guardamos el historial principal
            bool exito = await HistorialService.GuardarRiegoAsync(historial);

            if (exito)
            {
                // Guardamos datos auxiliares (Temperatura y Clima)
                // Usamos Task.Run para que no bloqueen el hilo principal si tardan
                _ = Task.Run(async () =>
                {
                    await ApiService.GuardarTemperaturaAsync(temp, temp, "Riego Auto", idPlantaDestino);
                    await ApiService.GuardarRegistroClimaticoAsync(humedadSuelo, humAire, temp, viento, idPlantaDestino);
                });

                await JS.InvokeVoidAsync("console.log", "✅ [AUTO] ¡Registro guardado exitosamente en la BD!");
            }
            else
            {
                await JS.InvokeVoidAsync("console.error", "❌ [AUTO] La API devolvió error al guardar.");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"❌ [AUTO] Error crítico en guardado: {ex.Message}");
        }
    }

    public void Dispose()
    {
        _timerGlobal?.Stop();
        _timerGlobal?.Dispose();
    }
}