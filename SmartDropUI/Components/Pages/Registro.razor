@page "/registro"
@using SmartDropUI.Services
@using SmartDropUI.Models
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject ILogger<Registro> Logger
@rendermode InteractiveServer

<PageTitle>Registro - SmartDrop</PageTitle>

<style>
    .registro-wrapper {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #05070a;
        position: relative;
        overflow: hidden;
        padding: 2rem;
    }

    .blob {
        position: absolute;
        border-radius: 50%;
        filter: blur(80px);
        opacity: 0.5;
        z-index: 0;
        animation: moveColors 15s infinite alternate;
    }

    .blob-1 {
        width: 500px;
        height: 500px;
        background: #00E676;
        top: -150px;
        left: -150px;
    }

    .blob-2 {
        width: 600px;
        height: 600px;
        background: #2979FF;
        bottom: -200px;
        right: -200px;
    }

    .glass-card-reg {
        position: relative;
        z-index: 10;
        background: rgba(20, 25, 40, 0.85);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        width: 100%;
        max-width: 650px;
        padding: 2.5rem;
        border-radius: 30px;
    }

    .reg-header {
        text-align: center;
        margin-bottom: 2rem;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding-bottom: 1rem;
    }

    .reg-title {
        font-family: 'Montserrat', sans-serif;
        font-size: 1.8rem;
        color: white;
        font-weight: 800;
    }

    .reg-label {
        color: #E2E8F0;
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 5px;
        margin-left: 10px;
        display: block;
    }

    .form-control-rounded option {
        background-color: #151B2B;
        color: white;
    }
</style>

<div class="registro-wrapper">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>

    <div class="glass-card-reg">
        <div class="reg-header">
            <h2 class="reg-title">Únete a SmartDrop</h2>
            <p style="color: #94A3B8;">Crea tu cuenta de monitoreo</p>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
            <div>
                <div class="mb-4">
                    <label class="reg-label">Identificación</label>
                    <input type="number" class="form-control-rounded" @bind="usuario.Identificacion" placeholder="Ej: 1065.." style="padding-left: 1.5rem;" />
                </div>
                <div class="mb-4">
                    <label class="reg-label">Nombre</label>
                    <input type="text" class="form-control-rounded" @bind="usuario.NombreCompleto" placeholder="Tu nombre" style="padding-left: 1.5rem;" />
                </div>
                <div class="mb-4">
                    <label class="reg-label">Correo</label>
                    <input type="email" class="form-control-rounded" @bind="usuario.Correo" placeholder="mail@ejemplo.com" style="padding-left: 1.5rem;" />
                </div>
            </div>

            <div>
                <div class="mb-4">
                    <label class="reg-label">Usuario</label>
                    <input type="text" class="form-control-rounded" @bind="usuario.NombreUsuario" placeholder="Usuario único" style="padding-left: 1.5rem;" />
                </div>
                <div class="mb-4">
                    <label class="reg-label">Rol</label>
                    <select class="form-control-rounded" @bind="usuario.Rol" style="padding-left: 1.5rem; appearance:auto;">
                        <option value="">Seleccionar...</option>
                        <option value="Cuidador">Cuidador</option>
                        <option value="Administrador">Administrador</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="reg-label">Contraseña</label>
                    <input type="password" class="form-control-rounded" @bind="usuario.Contrasena" placeholder="******" style="padding-left: 1.5rem;" />
                </div>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(mensajeError))
        {
            <div class="alert alert-danger mt-4">@mensajeError</div>
        }
        @if (!string.IsNullOrEmpty(mensajeExito))
        {
            <div class="alert alert-success mt-4">@mensajeExito</div>
        }

        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
            <button class="btn-outline" style="flex: 1;" @onclick='() => Navigation.NavigateTo("/login")'>Cancelar</button>
            <button class="btn-neon" style="flex: 2;" @onclick="HandleRegistro" disabled="@cargando">
                @(cargando ? "Guardando..." : "REGISTRARME")
            </button>
        </div>
    </div>
</div>

@code {
    private Usuario usuario = new Usuario();
    private bool cargando = false;
    private string mensajeError = "";
    private string mensajeExito = "";

    private async Task HandleRegistro()
    {
        mensajeError = "";
        if (usuario.Identificacion <= 0 || string.IsNullOrWhiteSpace(usuario.NombreUsuario)) { mensajeError = "Faltan datos."; return; }

        cargando = true;
        try
        {
            var usuarioRegistro = new Usuario
            {
                IdUsuario = usuario.Identificacion,
                Nombre = usuario.NombreCompleto,
                Email = usuario.Correo,
                NombreUsuario = usuario.NombreUsuario,
                Password = usuario.Contrasena,
                Rol = usuario.Rol
            };
            var (success, message) = await AuthService.RegistrarAsync(usuarioRegistro);
            if (success)
            {
                mensajeExito = "¡Cuenta creada!";
                await Task.Delay(1500);
                Navigation.NavigateTo("/login");
            }
            else { mensajeError = message; }
        }
        catch (Exception ex) { mensajeError = ex.Message; }
        finally { cargando = false; }
    }
}