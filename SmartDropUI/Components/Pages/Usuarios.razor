@page "/usuarios"
@using SmartDropUI.Services
@using SmartDropUI.Models
@inject RiegoService RiegoService
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject ILogger<Usuarios> Logger
@rendermode InteractiveServer

<PageTitle>Gestión de Usuarios - SmartDrop</PageTitle>

<style>
    /* Estilos generales */
    body { margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, sans-serif; }
    .usuarios-page { min-height: 100vh; background: linear-gradient(135deg, #d1fae5 0%, #ccfbf1 50%, #cffafe 100%); padding: 2rem; }
    .usuarios-container { max-width: 1600px; margin: 0 auto; }

    .btn-back-menu {
        background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem;
        border-radius: 0.75rem; font-weight: 600; cursor: pointer; display: inline-flex;
        align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); transition: all 0.3s ease;
    }
    .btn-back-menu:hover { background: #059669; transform: translateY(-2px); }

    .page-header { text-align: center; margin-bottom: 2.5rem; }
    .page-title { font-size: 2.25rem; font-weight: bold; color: #10b981; margin-bottom: 0.5rem; }
    .page-subtitle { font-size: 1rem; color: #6b7280; }

    /* Tabla */
    .usuarios-table-section {
        background: white; border-radius: 1.5rem; padding: 2rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); margin-bottom: 2rem;
    }
    .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .table-title { font-size: 1.5rem; font-weight: bold; color: #10b981; }
    
    .btn-refresh {
        background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem;
        border-radius: 0.75rem; font-weight: 600; cursor: pointer; display: flex;
        align-items: center; gap: 0.5rem; transition: all 0.3s ease;
    }
    .btn-refresh:hover { background: #2563eb; transform: translateY(-2px); }

    .table-container { overflow-x: auto; border-radius: 0.75rem; border: 1px solid #e5e7eb; }
    .usuarios-table { width: 100%; border-collapse: collapse; }
    .usuarios-table thead { background: #10b981; color: white; }
    .usuarios-table th { padding: 1rem; text-align: left; font-weight: 600; text-transform: uppercase; font-size: 0.875rem; }
    .usuarios-table td { padding: 1rem; border-bottom: 1px solid #e5e7eb; color: #374151; }
    .usuarios-table tbody tr:hover { background: #f0fdf4; }

    /* Badges Roles */
    .badge-rol { display: inline-block; padding: 0.375rem 0.875rem; border-radius: 9999px; font-weight: 600; font-size: 0.8rem; text-transform: uppercase; }
    .rol-admin { background: #dbeafe; color: #1e40af; } /* Azul */
    .rol-cuidador { background: #f3e8ff; color: #6b21a8; } /* Morado */
    .rol-otro { background: #fef3c7; color: #92400e; } /* Naranja */

    /* Grid Layout */
    .content-grid { display: grid; grid-template-columns: 300px 1fr 350px; gap: 2rem; }

    /* Sidebar Perfil */
    .profile-section { background: white; border-radius: 1.5rem; padding: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: center; height: fit-content; }
    .profile-avatar {
        width: 140px; height: 140px; background: #10b981; border-radius: 1.5rem;
        display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;
        font-size: 4rem; color: white;
    }
    .btn-upload-photo {
        background: #3b82f6; color: white; border: none; padding: 0.875rem 1.5rem;
        border-radius: 0.75rem; font-weight: 600; cursor: pointer; width: 100%; margin-bottom: 1.5rem;
    }
    .profile-role-title { font-size: 1.25rem; font-weight: bold; color: #10b981; margin-bottom: 0.5rem; }
    .profile-role-subtitle { font-size: 0.9rem; color: #6b7280; }

    /* Formulario Central */
    .info-section { background: white; border-radius: 1.5rem; padding: 2.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .section-title { font-size: 1.5rem; font-weight: bold; color: #10b981; margin-bottom: 1.5rem; text-align: center; }
    
    .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
    .form-group { display: flex; flex-direction: column; }
    .form-label { font-weight: 600; color: #374151; margin-bottom: 0.5rem; font-size: 0.9rem; }
    .form-input, .form-select {
        width: 100%; padding: 0.875rem 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem;
        font-size: 0.95rem; transition: all 0.3s ease; background: #f9fafb;
    }
    .form-input:focus { border-color: #10b981; outline: none; background: white; }

    /* Botones Acción */
    .action-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 2rem; }
    .btn-action { padding: 1rem; border: none; border-radius: 0.75rem; font-weight: 600; font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; color: white; }
    
    .btn-edit { background: #10b981; }
    .btn-edit:hover { background: #059669; }
    .btn-save { background: #3b82f6; }
    .btn-save:hover { background: #2563eb; }
    .btn-close-session { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
    .btn-close-session:hover { background: #b91c1c; }
    .btn-delete { background: #ef4444; }
    .btn-delete:hover { background: #dc2626; }

    /* Lista Derecha */
    .users-list-section { background: white; border-radius: 1.5rem; padding: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .list-title { font-size: 1.125rem; font-weight: bold; color: #10b981; margin-bottom: 1.5rem; text-align: center; }
    .user-item { padding: 1rem; border-bottom: 1px solid #e5e7eb; cursor: pointer; display: flex; align-items: center; gap: 1rem; transition: 0.2s; }
    .user-item:hover { background: #f0fdf4; }
    .user-item.active { background: #d1fae5; border-left: 4px solid #10b981; }
    .user-avatar-small { width: 40px; height: 40px; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; }
    .user-name { font-weight: 600; color: #1f2937; font-size: 0.95rem; }
    .user-role { font-size: 0.8rem; color: #6b7280; }

    @@media (max-width: 1200px) {
        .content-grid { grid-template-columns: 1fr; }
    }
</style>

<div class="usuarios-page">
    <div class="usuarios-container">
        <button class="btn-back-menu" @onclick='() => Navigation.NavigateTo("/dashboard")'>
            <span>⬅️</span> Volver al Dashboard
        </button>

        <div class="page-header">
            <h1 class="page-title">Panel de Gestión de Usuarios</h1>
            <p class="page-subtitle">Administra y gestiona los usuarios del sistema SmartDrop</p>
        </div>

        <div class="usuarios-table-section">
            <div class="table-header">
                <h2 class="table-title">👥 Usuarios Registrados</h2>
                <button class="btn-refresh" @onclick="CargarUsuarios">
                    <span>🔄</span> Actualizar
                </button>
            </div>

            @if (cargando)
            {
                <div style="text-align:center; padding: 2rem;">⏳ Cargando usuarios...</div>
            }
            else if (usuarios == null || !usuarios.Any())
            {
                <div style="text-align:center; padding: 2rem;">👤 No hay usuarios disponibles</div>
            }
            else
            {
                <div class="table-container">
                    <table class="usuarios-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Usuario</th>
                                <th>Rol</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var usuario in usuarios)
                            {
                                <tr @onclick="() => SeleccionarUsuarioDeLista(usuario)" style="cursor: pointer;">
                                    <td>@usuario.IdUsuario</td>
                                    <td>@usuario.Nombre</td>
                                    <td>@usuario.Email</td>
                                    <td>@usuario.NombreUsuario</td>
                                    <td>
                                        <span class="badge-rol @ObtenerClaseRol(usuario.Rol)">
                                            @usuario.Rol
                                        </span>
                                    </td>
                                    <td>
                                        @if (usuario.Accedio)
                                        {
                                            <span style="color: #10b981;">● Activo</span>
                                        }
                                        else
                                        {
                                            <span style="color: #6b7280;">○ Inactivo</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>

        <div class="content-grid">
            <div class="profile-section">
                <div class="profile-avatar">👤</div>
                <button class="btn-upload-photo"><span>📁</span> Subir Foto</button>
                <h3 class="profile-role-title">@usuarioSeleccionado.Rol</h3>
                <p class="profile-role-subtitle">Usuario del Sistema</p>
            </div>

            <div class="info-section">
                <h2 class="section-title">Información del Usuario</h2>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Identificación</label>
                        <input type="text" class="form-input" @bind="usuarioSeleccionado.Identificacion" readonly="@(!modoEdicion)" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nombre de Usuario</label>
                        <input type="text" class="form-input" @bind="usuarioSeleccionado.NombreUsuario" readonly="@(!modoEdicion)" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nombre Completo</label>
                        <input type="text" class="form-input" @bind="usuarioSeleccionado.NombreCompleto" readonly="@(!modoEdicion)" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" @bind="usuarioSeleccionado.Correo" readonly="@(!modoEdicion)" />
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Rol del Usuario</label>
                        <select class="form-select" @bind="usuarioSeleccionado.Rol" disabled="@(!modoEdicion || !esAdministrador)">
                            <option value="Administrador">Administrador</option>
                            <option value="Cuidador">Cuidador</option>
                        </select>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn-action btn-edit" @onclick="HabilitarEdicion"><span>✏️</span> Hacer Cambios</button>
                    <button class="btn-action btn-save" @onclick="GuardarCambios"><span>💾</span> Guardar Cambios</button>
                    <button class="btn-action btn-close-session" @onclick="CerrarSesion"><span>🚪</span> Cerrar Sesión</button>
                    
                    @if (esAdministrador)
                    {
                        <button class="btn-action btn-delete" @onclick="EliminarUsuario"><span>🗑️</span> Eliminar Usuario</button>
                    }
                </div>
            </div>

            <div class="users-list-section">
                <h3 class="list-title">Lista de Usuarios</h3>
                <div style="max-height: 600px; overflow-y: auto;">
                    @if (usuarios != null)
                    {
                        @foreach (var usuario in usuarios)
                        {
                            <div class="user-item @(usuario.IdUsuario == usuarioSeleccionado.Id ? "active" : "")"
                                 @onclick="() => SeleccionarUsuarioDeLista(usuario)">
                                <div class="user-avatar-small">👤</div>
                                <div>
                                    <div class="user-name">@usuario.Nombre</div>
                                    <div class="user-role">@usuario.Rol</div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private List<Usuario>? usuarios;
    private bool cargando = false;
    private bool modoEdicion = false;
    private bool esAdministrador = false; // Para controlar permisos

    private UsuarioGestionModel usuarioSeleccionado = new()
    {
        Id = 0,
        Identificacion = "",
        NombreUsuario = "Seleccione...",
        NombreCompleto = "",
        Correo = "",
        Rol = ""
    };

    public class UsuarioGestionModel
    {
        public int Id { get; set; }
        public string Identificacion { get; set; } = "";
        public string NombreUsuario { get; set; } = "";
        public string NombreCompleto { get; set; } = "";
        public string Correo { get; set; } = "";
        public string Rol { get; set; } = "";
    }

    protected override async Task OnInitializedAsync()
    {
        await CargarUsuarios();
    }

    private async Task CargarUsuarios()
    {
        cargando = true;
        try
        {
            // 1. Obtener quién está logueado
            var usuarioLogueado = await AuthService.GetUsuarioActualAsync();
            
            if (usuarioLogueado == null)
            {
                Navigation.NavigateTo("/login");
                return;
            }

            // Determinar si es admin para habilitar botones extra
            esAdministrador = usuarioLogueado.Rol.Equals("Administrador", StringComparison.OrdinalIgnoreCase);

            // 2. Obtener TODOS los usuarios de la API
            var todosLosUsuarios = await RiegoService.ObtenerUsuariosAsync();

            // 3. FILTRAR SEGÚN EL ROL
            if (esAdministrador)
            {
                // Si es Admin, ve a todos
                usuarios = todosLosUsuarios;
            }
            else
            {
                // Si es Cuidador (u otro), solo se ve a sí mismo
                usuarios = todosLosUsuarios.Where(u => u.IdUsuario == usuarioLogueado.IdUsuario).ToList();
                
                // Autoseleccionar al usuario para que no salga vacío
                if (usuarios.Any())
                {
                    SeleccionarUsuarioDeLista(usuarios.First());
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"Error: {ex.Message}");
        }
        finally
        {
            cargando = false;
        }
    }

    private void SeleccionarUsuarioDeLista(Usuario usuario)
    {
        usuarioSeleccionado = new UsuarioGestionModel
        {
            Id = usuario.IdUsuario,
            Identificacion = usuario.IdUsuario.ToString(),
            NombreUsuario = usuario.NombreUsuario,
            NombreCompleto = usuario.Nombre,
            Correo = usuario.Email,
            Rol = usuario.Rol
        };
        modoEdicion = false;
    }

    private string ObtenerClaseRol(string rol)
    {
        return rol.ToLower() switch
        {
            "administrador" => "rol-admin",
            "cuidador" => "rol-cuidador",
            _ => "rol-otro"
        };
    }

    private void HabilitarEdicion() => modoEdicion = true;

    private void GuardarCambios()
    {
        if (modoEdicion)
        {
            // Aquí agregarías la lógica para llamar a la API de actualización
            modoEdicion = false;
        }
    }

    private async Task CerrarSesion()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login", forceLoad: true);
    }

    private void EliminarUsuario()
    {
        // Lógica de eliminación (solo visible para admin)
    }
}