@using SmartDropUI.Models
@using SmartDropUI.Services
@using Microsoft.JSInterop
@inject RiegoService RiegoService
@inject IJSRuntime JSRuntime
@implements IDisposable

<div class="historial-container">
    <div class="historial-header">
        <div class="header-left">
            <span class="icon">📊</span>
            <h1>Historial del Sistema</h1>
        </div>
        <div class="header-right">
            <button class="nav-btn" @onclick="VolverAlDashboard">
                ← Atrás
            </button>
            <button class="nav-btn logout" @onclick="CerrarSesion">Salir</button>
        </div>
    </div>

    <div class="dashboard-grid">
        <!-- Gráfica de Humedad del Suelo -->
        <div class="chart-card">
            <h2>GRÁFICA DE LA HUMEDAD DEL SUELO</h2>
            <p class="chart-subtitle">Humedad – Vacío</p>
            <div style="height: 300px; position: relative;">
                <canvas id="chartHumedadSuelo"></canvas>
            </div>
        </div>

        <!-- Gráfica de Temperatura -->
        <div class="chart-card">
            <h2>GRÁFICO DE LA TEMPERATURA DEL AMBIENTE</h2>
            <p class="chart-subtitle">Temperatura – Vacío</p>
            <div style="height: 300px; position: relative;">
                <canvas id="chartTemperatura"></canvas>
            </div>
        </div>

        <!-- Controles -->
        <div class="controls-card">
            <h2>CONTROLES DEL SISTEMA</h2>
            <div class="controls-content">
                <button class="control-btn success" @onclick="RecargarHistorial" disabled="@cargandoDatos">
                    🔄 @(cargandoDatos ? "CARGANDO..." : "RECARGAR HISTORIAL")
                </button>
                <button class="control-btn primary" @onclick="IniciarRiegoManual">
                    💧 INICIAR RIEGO MANUAL
                </button>
                <div class="date-search">
                    <h3>BUSCAR POR FECHA</h3>
                    <input type="date" @bind="fechaBusqueda" />
                    <button class="control-btn info" @onclick="BuscarPorFecha">
                        🔍 BUSCAR
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Área de Historial de Datos -->
    <div class="historial-area">
        @if (cargandoDatos && !datosHistorial.Any())
        {
            <div class="loading">
                <div class="spinner"></div>
                <p>Cargando historial...</p>
            </div>
        }
        else if (datosHistorial.Any())
        {
            <div class="historial-content">
                <h2>📋 Historial de Registros</h2>
                <div class="table-container">
                    <table class="historial-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Fecha</th>
                                <th>Humedad Suelo</th>
                                <th>Temperatura</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var dato in datosHistorial)
                            {
                                <tr>
                                    <td>@dato.Id</td>
                                    <td>@dato.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td><span class="badge status">@dato.Humedad%</span></td>
                                    <td><span class="badge temp">@dato.Temperatura°C</span></td>
                                    <td>
                                        <span class="badge @(dato.Estado == "Regado" ? "success" : "warning")">
                                            @dato.Estado
                                        </span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
        else
        {
            <div class="historial-content">
                <div class="historial-icon">📊</div>
                <h2>Área de Historial de Datos</h2>
                <p>Los registros históricos del sistema aparecerán aquí</p>
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public EventCallback OnVolverAlDashboard { get; set; }
    [Parameter] public EventCallback OnCerrarSesion { get; set; }

    private List<DatosRiegoModel> datosHistorial = new();
    private List<DatosSensorModel> datosParaGraficas = new();
    private DateTime fechaBusqueda = DateTime.Now;
    private bool cargandoDatos = false;
    private System.Threading.Timer? timer;
    private bool graficasInicializadas = false;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !graficasInicializadas)
        {
            try
            {
                // Esperar a que el DOM y Chart.js estén listos
                await Task.Delay(1000);

                // Inicializar las gráficas
                await InicializarGraficas();
                graficasInicializadas = true;

                // Configurar timer para actualización automática
                timer = new System.Threading.Timer(async _ =>
                {
                    await CargarDatos();
                    await ActualizarGraficas();
                    await InvokeAsync(StateHasChanged);
                }, null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error en OnAfterRenderAsync: {ex.Message}");
            }
        }
    }

    private async Task CargarDatos()
    {
        try
        {
            cargandoDatos = true;
            StateHasChanged();

            // Cargar historial
            datosHistorial = await RiegoService.ObtenerHistorialAsync();

            // Generar 30 puntos de datos para las gráficas
            datosParaGraficas.Clear();
            for (int i = 0; i < 30; i++)
            {
                var datos = await RiegoService.ObtenerDatosActualesAsync();
                datosParaGraficas.Add(datos);
                await Task.Delay(50);
            }

            cargandoDatos = false;
            StateHasChanged();

            // Actualizar gráficas si ya están inicializadas
            if (graficasInicializadas)
            {
                await ActualizarGraficas();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar datos: {ex.Message}");
            cargandoDatos = false;
            StateHasChanged();
        }
    }

    private async Task InicializarGraficas()
    {
        if (!datosParaGraficas.Any()) return;

        var labels = Enumerable.Range(1, 30).Select(i => i.ToString()).ToArray();
        var valoresHumedad = datosParaGraficas.Select(d => (object)d.HumedadSuelo).ToArray();
        var valoresTemp = datosParaGraficas.Select(d => (object)d.Temperatura).ToArray();

        try
        {
            await JSRuntime.InvokeVoidAsync("eval", @"
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js no está cargado');
                } else {
                    console.log('Chart.js está disponible');
                }
            ");

            // Crear gráfica de humedad
            await JSRuntime.InvokeVoidAsync("eval", $@"
                (function() {{
                    try {{
                        const ctx = document.getElementById('chartHumedadSuelo');
                        if (!ctx) {{
                            console.error('Canvas chartHumedadSuelo no encontrado');
                            return;
                        }}

                        if (window.chartHumedad) {{
                            window.chartHumedad.destroy();
                        }}

                        window.chartHumedad = new Chart(ctx, {{
                            type: 'line',
                            data: {{
                                labels: {System.Text.Json.JsonSerializer.Serialize(labels)},
                                datasets: [{{
                                    label: 'Humedad del Suelo (%)',
                                    data: {System.Text.Json.JsonSerializer.Serialize(valoresHumedad)},
                                    borderColor: '#10b981',
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    borderWidth: 3,
                                    tension: 0.4,
                                    fill: true,
                                    pointRadius: 4,
                                    pointBackgroundColor: '#10b981'
                                }}]
                            }},
                            options: {{
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {{
                                    legend: {{
                                        display: true,
                                        position: 'top'
                                    }}
                                }},
                                scales: {{
                                    y: {{
                                        beginAtZero: true,
                                        max: 100,
                                        ticks: {{
                                            callback: function(value) {{
                                                return value + '%';
                                            }}
                                        }}
                                    }},
                                    x: {{
                                        title: {{
                                            display: true,
                                            text: 'Tiempo (m)'
                                        }}
                                    }}
                                }}
                            }}
                        }});
                        console.log('Gráfica de humedad creada');
                    }} catch(e) {{
                        console.error('Error al crear gráfica de humedad:', e);
                    }}
                }})();
            ");

            // Crear gráfica de temperatura
            await JSRuntime.InvokeVoidAsync("eval", $@"
                (function() {{
                    try {{
                        const ctx = document.getElementById('chartTemperatura');
                        if (!ctx) {{
                            console.error('Canvas chartTemperatura no encontrado');
                            return;
                        }}

                        if (window.chartTemp) {{
                            window.chartTemp.destroy();
                        }}

                        window.chartTemp = new Chart(ctx, {{
                            type: 'line',
                            data: {{
                                labels: {System.Text.Json.JsonSerializer.Serialize(labels)},
                                datasets: [{{
                                    label: 'Temperatura (°C)',
                                    data: {System.Text.Json.JsonSerializer.Serialize(valoresTemp)},
                                    borderColor: '#ef4444',
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                    borderWidth: 3,
                                    tension: 0.4,
                                    fill: true,
                                    pointRadius: 4,
                                    pointBackgroundColor: '#ef4444'
                                }}]
                            }},
                            options: {{
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {{
                                    legend: {{
                                        display: true,
                                        position: 'top'
                                    }}
                                }},
                                scales: {{
                                    y: {{
                                        beginAtZero: true,
                                        max: 40,
                                        ticks: {{
                                            callback: function(value) {{
                                                return value + '°C';
                                            }}
                                        }}
                                    }},
                                    x: {{
                                        title: {{
                                            display: true,
                                            text: 'Tiempo (m)'
                                        }}
                                    }}
                                }}
                            }}
                        }});
                        console.log('Gráfica de temperatura creada');
                    }} catch(e) {{
                        console.error('Error al crear gráfica de temperatura:', e);
                    }}
                }})();
            ");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al inicializar gráficas: {ex.Message}");
        }
    }

    private async Task ActualizarGraficas()
    {
        await InicializarGraficas();
    }

    private async Task RecargarHistorial()
    {
        await CargarDatos();
    }

    private async Task IniciarRiegoManual()
    {
        try
        {
            await RiegoService.ActivarRiegoManualAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al iniciar riego: {ex.Message}");
        }
    }

    private void BuscarPorFecha()
    {
        var todosDatos = datosHistorial.ToList();
        datosHistorial = todosDatos.Where(d => d.Fecha.Date == fechaBusqueda.Date).ToList();
        StateHasChanged();
    }

    private async Task VolverAlDashboard()
    {
        await OnVolverAlDashboard.InvokeAsync();
    }

    private async Task CerrarSesion()
    {
        await OnCerrarSesion.InvokeAsync();
    }

    public void Dispose()
    {
        timer?.Dispose();
    }
}