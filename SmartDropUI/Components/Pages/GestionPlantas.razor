@page "/gestion-plantas"
@using SmartDropUI.Services
@using SmartDropUI.Models
@inject ApiService ApiService  // <--- USAMOS EL SERVICIO CORRECTO
@inject NavigationManager Navigation
@inject ILogger<GestionPlantas> Logger
@rendermode InteractiveServer

<PageTitle>Gestión de Plantas - SmartDrop</PageTitle>

<style>
/* Estilos generales */
body {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Roboto, sans-serif;
}

.gestion-page {
    min-height: 100vh;
    background: linear-gradient(135deg, #d1fae5 0%, #ccfbf1 50%, #cffafe 100%);
    padding: 2rem;
}

.header-bar {
    background: #10b981;
    padding: 1rem 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-radius: 15px;
    margin-bottom: 2rem;
}

.header-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: white;
    display: flex;
    align-items: center;
    gap: 10px;
}

.btn-back {
    background: white;
    color: #10b981;
    border: none;
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    transition: 0.2s;
}

    .btn-back:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

.main-title {
    text-align: center;
    font-size: 2rem;
    font-weight: 800;
    color: #10b981;
    margin-bottom: 2rem;
    text-transform: uppercase;
}

/* Layout Principal */
.content-container {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 2rem;
    max-width: 1200px;
    margin: 0 auto;
}

/* Formulario */
.form-section {
    background: white;
    border-radius: 20px;
    padding: 2.5rem;
    box-shadow: 0 10px 25px rgba(0,0,0,0.05);
}

.section-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: #374151;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.full-width {
    grid-column: 1 / -1;
}

.form-label {
    font-weight: 600;
    color: #4b5563;
    font-size: 0.9rem;
}

.form-input, .form-select, .form-textarea {
    padding: 0.8rem;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    font-size: 1rem;
    transition: 0.2s;
}

    .form-input:focus, .form-select:focus, .form-textarea:focus {
        border-color: #10b981;
        outline: none;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

.form-textarea {
    min-height: 100px;
    resize: vertical;
}

/* Botones de Acción */
.action-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: 2rem;
}

.btn {
    padding: 1rem;
    border: none;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
    transition: 0.2s;
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
}

.btn-register {
    background: #10b981;
    grid-column: 1 / -1;
    font-size: 1.1rem;
}

    .btn-register:hover {
        background: #059669;
        transform: translateY(-2px);
    }

.btn-clear {
    background: #6b7280;
}

    .btn-clear:hover {
        background: #4b5563;
    }

.btn-dashboard {
    background: #3b82f6;
}

    .btn-dashboard:hover {
        background: #2563eb;
    }

/* Sidebar Derecha */
.sidebar-section {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.info-card {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    text-align: center;
    box-shadow: 0 10px 25px rgba(0,0,0,0.05);
}

/* Alertas */
.alert {
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1.5rem;
    font-weight: 600;
    text-align: center;
}

.alert-error {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fecaca;
}

.alert-success {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #a7f3d0;
}

/* Upload Imagen */
.upload-box {
    border: 2px dashed #10b981;
    background: #f0fdf4;
    border-radius: 15px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: 0.2s;
}

    .upload-box:hover {
        background: #dcfce7;
    }

@@media (max-width: 768px) {
    .content-container {
        grid-template-columns: 1fr;
    }

    .form-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<div class="gestion-page">
    <div class="header-bar">
        <div class="header-title">
            <span>🌿</span> GESTIÓN DE PLANTAS
        </div>
        <button class="btn-back" @onclick="IrAPlantas">Volver a la lista</button>
    </div>

    <h1 class="main-title">AGREGAR NUEVA PLANTA</h1>

    <div class="content-container">
        <div class="form-section">

            @if (!string.IsNullOrEmpty(mensajeAlerta))
            {
                    <div class="alert @tipoAlertaClass">@mensajeAlerta</div>
            }

            <h2 class="section-title">📝 Información de la Planta</h2>

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">ID Sistema *</label>
                    <input type="number" class="form-input" placeholder="Ej: 101" @bind="planta.IdPlanta" />
                </div>

                <div class="form-group">
                    <label class="form-label">Nombre *</label>
                    <input type="text" class="form-input" placeholder="Ej: Sábila" @bind="planta.NombrePlanta" />
                </div>

                <div class="form-group full-width">
                    <label class="form-label">Descripción</label>
                    <textarea class="form-textarea" placeholder="Breve descripción..." @bind="planta.Descripcion"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Humedad Óptima (%) *</label>
                    <input type="number" class="form-input" placeholder="0-100" @bind="planta.NivelOptimoHumedad" />
                </div>

                <div class="form-group">
                    <label class="form-label">Temperatura Óptima (°C) *</label>
                    <input type="number" class="form-input" placeholder="Ej: 24" @bind="planta.NivelOptimoTemperatura" />
                </div>

                <div class="form-group full-width">
                    <label class="form-label">Luz Necesaria *</label>
                    <select class="form-select" @bind="planta.NivelOptimoLuz">
                        <option value="0">-- Seleccione Nivel de Luz --</option>
                        <option value="200">Baja (Sombra)</option>
                        <option value="500">Media (Semisombra)</option>
                        <option value="1000">Alta (Sol directo)</option>
                    </select>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-register" @onclick="RegistrarPlanta" disabled="@cargando">
                    @if (cargando)
                    {
                        <span>⏳ Guardando...</span>
                    }
                    else
                    {

                        <span>💾 REGISTRAR PLANTA</span>
                    }
                </button>

                <button class="btn btn-clear" @onclick="LimpiarFormulario">
                    <span>🔄</span> Limpiar
                </button>

                <button class="btn btn-dashboard" @onclick="IrAlDashboard">
                    <span>🎛️</span> Dashboard
                </button>
            </div>
        </div>

        <div class="sidebar-section">
            <div class="info-card">
                <h3 style="color:#10b981; margin-bottom:1rem;">Imagen de Referencia</h3>
                <div class="upload-box">
                    <span style="font-size:2rem;">📷</span>
                    <p style="font-size:0.9rem; color:#6b7280; margin-top:0.5rem;">(Opcional)</p>
                </div>
                <input type="text" class="form-input" style="margin-top:1rem;" placeholder="Pegar URL si deseas..." @bind="planta.RutaImagen" />

                @if (!string.IsNullOrEmpty(planta.RutaImagen))
                {
                        <img src="@planta.RutaImagen" style="width:100%; height:150px; object-fit:cover; border-radius:10px; margin-top:1rem;" />
                }
            </div>

            <div class="info-card">
                <span style="font-size:2.5rem; display:block; margin-bottom:10px;">💡</span>
                <h3 style="font-size:1.1rem; font-weight:700; color:#374151;">Consejo SmartDrop</h3>
                <p style="color:#6b7280; font-size:0.9rem; margin-top:0.5rem;">
                    Configura correctamente los niveles óptimos para que el sistema cuide tus plantas automáticamente.
                </p>
            </div>
        </div>
    </div>
</div>

@code {
    // Modelo
    private PlantaModel planta = new();

    // Estado
    private bool cargando = false;
    private string mensajeAlerta = "";
    private string tipoAlertaClass = "";

    // Navegación
    private void IrAPlantas() => Navigation.NavigateTo("/plantas");
    private void IrAlDashboard() => Navigation.NavigateTo("/dashboard");

    // Limpiar
    private void LimpiarFormulario()
    {
        planta = new PlantaModel();
        mensajeAlerta = "";
    }

    // Método Registrar
    private async Task RegistrarPlanta()
    {
        // 1. Validaciones
        if (planta.IdPlanta <= 0)
        {
            MostrarMensaje("El ID debe ser mayor a 0.", "error");
            return;
        }
        if (string.IsNullOrWhiteSpace(planta.NombrePlanta))
        {
            MostrarMensaje("El nombre de la planta es obligatorio.", "error");
            return;
        }
        if (planta.NivelOptimoHumedad < 0 || planta.NivelOptimoHumedad > 100)
        {
            MostrarMensaje("La humedad debe estar entre 0% y 100%.", "error");
            return;
        }
        if (planta.NivelOptimoLuz <= 0)
        {
            MostrarMensaje("Por favor selecciona un nivel de luz.", "error");
            return;
        }

        // Nota: Ya NO validamos la imagen como obligatoria.

        cargando = true;
        mensajeAlerta = "";

        try
        {
            // 2. Llamada al ApiService (Usa la conexión correcta)
            bool exito = await ApiService.RegistrarPlantaAsync(planta);

            if (exito)
            {
                MostrarMensaje("✅ Planta registrada exitosamente en la Base de Datos.", "success");
                await Task.Delay(2000);
                LimpiarFormulario();
            }
            else
            {
                MostrarMensaje("❌ Error al guardar. Verifique que el ID no esté duplicado.", "error");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"Excepción al guardar: {ex.Message}");
            MostrarMensaje("❌ Error de conexión con el servidor.", "error");
        }
        finally
        {
            cargando = false;
        }
    }

    private void MostrarMensaje(string mensaje, string tipo)
    {
        mensajeAlerta = mensaje;
        tipoAlertaClass = (tipo == "success") ? "alert-success" : "alert-error";
    }
}