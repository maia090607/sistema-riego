@page "/riego"
@using SmartDropUI.Services
@using SmartDropUI.Models
@using System.Timers
@inject ArduinoService ArduinoService
@inject ApiService _apiService
@inject AuthService AuthService
@inject HistorialRiegoService HistorialService
@inject ClimaService _climaService 
@inject NavigationManager Navigation
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>Control de Riego</PageTitle>

<style>
    /* Estilos generales */
    .riego-container { padding: 2rem; max-width: 1200px; margin: 0 auto; font-family: 'Segoe UI', sans-serif; }
    
    .btn-back {
        background-color: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem;
        border-radius: 8px; font-weight: 700; cursor: pointer; display: inline-flex;
        align-items: center; gap: 8px; margin-bottom: 1.5rem; transition: 0.2s;
    }
    .btn-back:hover { background-color: #4b5563; transform: translateX(-3px); }

    .header-title {
        color: #10b981; font-weight: 900; font-size: 1.8rem; display: flex; align-items: center;
        gap: 12px; margin-bottom: 2rem; background: white; padding: 1.5rem;
        border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    }

    /* Plant Info */
    .plant-info {
        margin-bottom: 2rem; padding: 1rem; background: #f0fdf4; border-radius: 10px;
        text-align: center; border: 1px solid #bbf7d0; color: #15803d; font-weight: 600;
    }

    /* Cards */
    .cards-row { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
    .status-card {
        background: white; border-radius: 20px; padding: 2.5rem; text-align: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.04); border-left: 6px solid;
    }
    .card-icon { font-size: 3.5rem; margin-bottom: 1rem; display: block; }
    .card-label { color: #6b7280; font-weight: 700; text-transform: uppercase; margin-bottom: 0.5rem; }
    .card-value { font-size: 2rem; font-weight: 800; color: #374151; }

    /* Panel Manual */
    .manual-panel { background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); overflow: hidden; margin-top: 1rem; }
    .panel-header { padding: 1.5rem; text-align: center; border-bottom: 1px solid #f3f4f6; color: #6b7280; font-weight: 700; }
    .panel-body { padding: 3rem 4rem; text-align: center; }
    .info-text { color: #6b7280; margin-bottom: 2rem; }

    .btn-riego {
        width: 100%; padding: 1.2rem; border-radius: 10px; border: none; font-weight: 800;
        font-size: 1.1rem; color: white; cursor: pointer; display: flex; align-items: center;
        justify-content: center; gap: 12px; text-transform: uppercase; transition: 0.2s;
    }
    .btn-iniciar { background-color: #10b981; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.25); }
    .btn-detener { background-color: #ef4444; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.25); }
    .btn-riego:disabled { opacity: 0.7; cursor: wait; }

    .border-green { border-left-color: #10b981; }
    .border-blue { border-left-color: #3b82f6; }
    .text-blue { color: #3b82f6; }
    .icon-active { color: #10b981; }
    .icon-inactive { color: #ef4444; }
</style>

<div class="riego-container">
    <button class="btn-back" @onclick="VolverAtras"><span>⬅</span> Atrás</button>

    <div class="header-title"><span>💧</span> CONTROL DE RIEGO</div>

    <div class="plant-info">
        🌿 Planta Activa: <strong>@nombrePlantaActiva</strong> (ID: @idPlantaActiva)
    </div>

    <div class="cards-row">
        <div class="status-card border-green">
            <span class="card-icon">
                @if(bombaActiva) { <span class="icon-active">🌊</span> } else { <span class="icon-inactive">⛔</span> }
            </span>
            <div class="card-label">ESTADO BOMBA</div>
            <div class="card-value" style="color: @(bombaActiva ? "#10b981" : "#6b7280")">
                @(bombaActiva ? "ENCENDIDA" : "APAGADA")
            </div>
        </div>

        <div class="status-card border-blue">
            <span class="card-icon">🌱</span>
            <div class="card-label">HUMEDAD SUELO</div>
            <div class="card-value text-blue">@humedadActual %</div>
        </div>
    </div>

    <div class="manual-panel">
        <div class="panel-header">Panel de Control Manual</div>
        <div class="panel-body">
            @if (riegoManualActivo)
            {
                <p class="info-text">El sistema está en modo manual. La bomba permanecerá encendida.</p>
                <button class="btn-riego btn-detener" @onclick="DetenerRiegoManual" disabled="@procesando">
                    @if (procesando) { <span>⏳ DETENIENDO...</span> } else { <span>🛑 DETENER RIEGO MANUAL</span> }
                </button>
            }
            else
            {
                <p class="info-text">Presione para activar la bomba y desactivar el control automático.</p>
                <button class="btn-riego btn-iniciar" @onclick="IniciarRiegoManual" disabled="@procesando">
                    @if (procesando) { <span>⏳ INICIANDO...</span> } else { <span>💧 INICIAR RIEGO MANUAL</span> }
                </button>
            }
        </div>
    </div>
</div>

@code {
    private bool riegoManualActivo = false;
    private bool bombaActiva = false;
    private int humedadActual = 0;
    private bool procesando = false;
    private Timer? _timer;
    
    private string nombrePlantaActiva = "Cargando...";
    private int idPlantaActiva = 0;

    // ✅ VARIABLE DE CONTROL PARA EVITAR DUPLICADOS
    private DateTime _ultimoRegistro = DateTime.MinValue;

    protected override async Task OnInitializedAsync()
    {
        ArduinoService.DatosRecibidos += OnDatosArduinoRecibidos;
        await CargarInfoPlanta();
        await ActualizarEstado();
        _timer = new Timer(1000);
        _timer.Elapsed += async (s, e) => await ActualizarEstado();
        _timer.AutoReset = true;
        _timer.Start();
    }

    private async Task CargarInfoPlanta()
    {
        try {
            var usuario = await AuthService.GetUsuarioActualAsync();
            if (usuario != null) {
                var plantas = await _apiService.ObtenerPlantasPorUsuarioAsync(usuario.IdUsuario);
                if (plantas != null && plantas.Any()) {
                    var p = plantas.First();
                    nombrePlantaActiva = p.NombrePlanta;
                    idPlantaActiva = p.IdPlanta;
                } else {
                    nombrePlantaActiva = "Sin Planta Asignada";
                }
            }
        } catch {}
    }

    private void VolverAtras() => Navigation.NavigateTo("/dashboard");

    private void OnDatosArduinoRecibidos(DatosArduinoModel datos)
    {
        // Lógica de detección automática
        if (!procesando && !bombaActiva && datos.BombaEncendida)
        {
            // Solo guardamos si pasaron más de 60 segundos desde el último guardado
            if ((DateTime.Now - _ultimoRegistro).TotalSeconds > 60)
            {
                Console.WriteLine("🌊 Riego Detectado (Auto). Guardando...");
                _ = RegistrarHistorialYTemperatura(datos.Humedad);
            }
        }

        if (!procesando)
        {
            ActualizarVariablesLocales(datos.Humedad, datos.BombaEncendida, datos.ModoManual);
        }
    }

    private async Task ActualizarEstado()
    {
        if (procesando) return;
        try
        {
            var estado = await ArduinoService.ObtenerEstadoAsync();
            if (estado != null)
            {
                await InvokeAsync(() => 
                {
                    // Doble chequeo por polling con protección anti-spam
                    if (!bombaActiva && estado.BombaEncendida)
                    {
                        if ((DateTime.Now - _ultimoRegistro).TotalSeconds > 60)
                        {
                            Console.WriteLine("🌊 Riego Detectado (Polling). Guardando...");
                            _ = RegistrarHistorialYTemperatura(estado.Humedad);
                        }
                    }
                    ActualizarVariablesLocales(estado.Humedad, estado.BombaEncendida, estado.ModoManual);
                });
            }
        }
        catch { }
    }

    private void ActualizarVariablesLocales(int humedad, bool bomba, bool manual)
    {
        bool cambio = false;
        if (humedadActual != humedad) { humedadActual = humedad; cambio = true; }
        if (bombaActiva != bomba) { bombaActiva = bomba; cambio = true; }
        if (riegoManualActivo != manual) { riegoManualActivo = manual; cambio = true; }
        if (cambio) StateHasChanged();
    }

    // ✅ Riego Manual: Guarda explícitamente al dar clic
    private async Task IniciarRiegoManual()
    {
        procesando = true;
        StateHasChanged();
        try
        {
            bool exito = await ArduinoService.IniciarRiegoManualAsync();
            if (exito) 
            {
                riegoManualActivo = true;
                
                // Verificar anti-spam también aquí por si acaso
                if ((DateTime.Now - _ultimoRegistro).TotalSeconds > 60)
                {
                    Console.WriteLine("🌊 Riego Manual Iniciado. Guardando...");
                    await RegistrarHistorialYTemperatura(humedadActual);
                }
            }
        }
        finally { procesando = false; StateHasChanged(); }
    }

    private async Task DetenerRiegoManual()
    {
        procesando = true;
        StateHasChanged();
        try
        {
            bool exito = await ArduinoService.DetenerRiegoManualAsync();
            if (exito)
            {
                riegoManualActivo = false;
                bombaActiva = false;
            }
        }
        finally { procesando = false; StateHasChanged(); }
    }

    // ✅ MÉTODO CENTRAL DE GUARDADO
    private async Task RegistrarHistorialYTemperatura(int humedadDelMomento)
    {
        // Bloquear inmediatamente para evitar duplicados
        _ultimoRegistro = DateTime.Now;

        int idPlantaAGuardar = idPlantaActiva > 0 ? idPlantaActiva : 0;
        float temperaturaCapturada = 25.0f;

        try
        {
            // 1. Obtener Clima
            try {
               var clima = await _climaService.ObtenerClimaActualAsync();
               if (clima != null) temperaturaCapturada = (float)clima.Temperatura;
            } catch { }

            // 2. Guardar Historial
            var historial = new HistorialRiegoModel {
                Fecha = DateTime.Now,
                Humedad = humedadDelMomento,
                Temperatura = temperaturaCapturada,
                IdPlanta = idPlantaAGuardar
            };
            await HistorialService.GuardarRiegoAsync(historial);

            // 3. Guardar Temperatura (Tabla aparte)
            await _apiService.GuardarTemperaturaAsync(
                temperaturaCapturada,
                temperaturaCapturada,
                $"Riego H:{humedadDelMomento}%",
                idPlantaAGuardar
            );

            Console.WriteLine("✅ Riego registrado exitosamente en BD");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error guardando datos: {ex.Message}");
            // Si falló, reseteamos el tiempo para permitir reintentar
            _ultimoRegistro = DateTime.MinValue; 
        }
    }

    public void Dispose()
    {
        if (_timer != null) { _timer.Stop(); _timer.Dispose(); }
        ArduinoService.DatosRecibidos -= OnDatosArduinoRecibidos;
    }
}