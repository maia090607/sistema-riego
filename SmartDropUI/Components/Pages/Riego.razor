@page "/riego"
@using SmartDropUI.Services
@using SmartDropUI.Models
@inject ArduinoService ArduinoService
@inject HistorialRiegoService HistorialService
@inject ApiService ApiService
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>Control de Riego - SmartDrop</PageTitle>

<div class="container p-4" style="max-width: 1000px;">
    <div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-white rounded shadow-sm">
        <div class="d-flex align-items-center gap-3">
            <h2 class="fw-bold text-success m-0">🌊 CONTROL DE RIEGO</h2>
            <span class="badge @(riegoManualActivo ? "bg-warning text-dark" : "bg-success") rounded-pill px-3">
                @(riegoManualActivo ? "MODO MANUAL" : "MODO AUTOMÁTICO")
            </span>
        </div>
        <button class="btn btn-outline-secondary btn-sm" @onclick='() => Navigation.NavigateTo("/dashboard")'>
            ⬅ Volver
        </button>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card h-100 shadow-sm border-0 text-center p-3"
                 style="border-top: 5px solid @(bombaActiva ? "#198754" : "#dc3545") !important;">
                <div class="display-4 mb-2">@(bombaActiva ? "💧" : "🛑")</div>
                <h5 class="text-muted">ESTADO BOMBA</h5>
                <h2 class="fw-bold @(bombaActiva ? "text-success" : "text-danger")">
                    @(bombaActiva ? "ENCENDIDA" : "APAGADA")
                </h2>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100 shadow-sm border-0 text-center p-3"
                 style="border-top: 5px solid #0dcaf0 !important;">
                <div class="display-4 mb-2">📡</div>
                <h5 class="text-muted">CONEXIÓN</h5>
                <h2 class="fw-bold text-info">
                    @(ArduinoService.EstaConectado ? "ONLINE" : "OFFLINE")
                </h2>
            </div>
        </div>
    </div>

    <div class="card shadow border-0 rounded-4">
        <div class="card-body p-5 text-center">
            <h4 class="fw-bold text-secondary mb-4">🛠️ Operación Manual</h4>

            @if (!riegoManualActivo)
            {
                <button class="btn btn-success w-100 py-3 fw-bold fs-4 shadow transition-btn"
                        @onclick="IniciarRiegoManual"
                        disabled="@esperandoRespuesta">
                    @if (esperandoRespuesta)
                    {
                        <span>⏳ Procesando...</span>
                    }
                    else
                    {
                        <span>▶ INICIAR RIEGO MANUAL</span>
                    }
                </button>
                <div class="alert alert-info mt-4 mb-0">
                    <small>ℹ️ Al activar el modo manual, el sistema automático se pausará temporalmente.</small>
                </div>
            }
            else
            {
                <div class="p-3 mb-4 bg-light rounded border border-warning">
                    <h5 class="text-muted mb-1">Tiempo de riego activo</h5>
                    <h1 class="fw-bold text-warning display-5">@tiempoRiego s</h1>
                </div>

                <button class="btn btn-danger w-100 py-3 fw-bold fs-4 shadow transition-btn"
                        @onclick="DetenerRiegoManual"
                        disabled="@esperandoRespuesta">
                    @if (esperandoRespuesta)
                    {
                        <span>⏳ Deteniendo...</span>
                    }
                    else
                    {
                        <span>⏹ DETENER RIEGO MANUAL</span>
                    }
                </button>
            }
        </div>
    </div>
</div>

<style>
    .transition-btn {
        transition: all 0.3s ease;
    }

        .transition-btn:hover {
            transform: translateY(-3px);
        }

        .transition-btn:active {
            transform: scale(0.98);
        }
</style>

@code {
    private bool riegoManualActivo = false;
    private bool esperandoRespuesta = false;
    private bool bombaActiva = false;
    private int tiempoRiego = 0;
    private System.Timers.Timer? timer;
    private System.Timers.Timer? pollingTimer;
    private int _idPlantaValido = 0; // Variable para guardar un ID real

    protected override async Task OnInitializedAsync()
    {
        // 1. Obtener un ID de planta válido al iniciar
        await CargarIdPlantaValido();

        // 2. Polling para actualizar estado visual
        pollingTimer = new System.Timers.Timer(2000);
        pollingTimer.Elapsed += async (s, e) => await ConsultarEstadoServidor();
        pollingTimer.AutoReset = true;
        pollingTimer.Start();

        await ConsultarEstadoServidor();
    }

    private async Task CargarIdPlantaValido()
    {
        try
        {
            var usuario = await AuthService.GetUsuarioActualAsync();
            if (usuario != null)
            {
                var plantas = await ApiService.ObtenerPlantasPorUsuarioAsync(usuario.IdUsuario);
                if (plantas != null && plantas.Any())
                {
                    _idPlantaValido = plantas.First().IdPlanta;
                    Console.WriteLine($"✅ Planta vinculada para historial: ID {_idPlantaValido}");
                }
                else
                {
                    Console.WriteLine("⚠️ ADVERTENCIA: El usuario no tiene plantas registradas. El historial fallará.");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error cargando plantas: {ex.Message}");
        }
    }

    private async Task ConsultarEstadoServidor()
    {
        try
        {
            var datos = await ArduinoService.ObtenerEstadoAsync();
            if (datos != null)
            {
                await InvokeAsync(() =>
                {
                    bombaActiva = datos.BombaEncendida;

                    if (datos.ModoManual && !riegoManualActivo)
                    {
                        riegoManualActivo = true;
                        IniciarTimerVisual();
                    }
                    else if (!datos.ModoManual && riegoManualActivo)
                    {
                        riegoManualActivo = false;
                        DetenerTimerVisual();
                    }
                    StateHasChanged();
                });
            }
        }
        catch { }
    }

    private async Task IniciarRiegoManual()
    {
        if (_idPlantaValido == 0)
        {
            await JS.InvokeVoidAsync("alert", "⚠️ Error: No tienes plantas registradas. Crea una planta primero.");
            return;
        }

        esperandoRespuesta = true;

        // 1. Intentar enviar comando
        bool exitoArduino = await ArduinoService.IniciarRiegoManualAsync();

        // ✅ CAMBIO CRÍTICO:
        // Asumimos que si el usuario le dio clic, quiere registrar el riego.
        // Guardamos el historial INDEPENDIENTEMENTE de la respuesta del Arduino
        // para evitar que un fallo de comunicación bloquee el registro en base de datos.

        riegoManualActivo = true;
        bombaActiva = true;
        IniciarTimerVisual();

        try
        {
            var nuevoRiego = new HistorialRiegoModel
            {
                Fecha = DateTime.Now,
                Humedad = 50,
                Temperatura = 25,
                IdPlanta = _idPlantaValido
            };

            bool guardado = await HistorialService.GuardarRiegoAsync(nuevoRiego);

            if (guardado)
            {
                if (!exitoArduino)
                {
                    // Guardó en BD pero Arduino no respondió (caso común de timeout)
                    await JS.InvokeVoidAsync("alert", "✅ Riego registrado, pero el Arduino tardó en confirmar. Verifica que la bomba encendió.");
                }
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "❌ Error al guardar en base de datos.");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"❌ Error crítico: {ex.Message}");
        }

        esperandoRespuesta = false;
    }

    private async Task DetenerRiegoManual()
    {
        esperandoRespuesta = true;
        bool exito = await ArduinoService.DetenerRiegoManualAsync();

        if (exito)
        {
            await ArduinoService.ActivarModoAutomaticoAsync();
            riegoManualActivo = false;
            bombaActiva = false;
            DetenerTimerVisual();
        }
        esperandoRespuesta = false;
    }

    private void IniciarTimerVisual()
    {
        if (timer == null)
        {
            tiempoRiego = 0;
            timer = new System.Timers.Timer(1000);
            timer.Elapsed += (s, e) =>
            {
                tiempoRiego++;
                InvokeAsync(StateHasChanged);
            };
            timer.Start();
        }
    }

    private void DetenerTimerVisual()
    {
        if (timer != null)
        {
            timer.Stop();
            timer.Dispose();
            timer = null;
        }
        tiempoRiego = 0;
    }

    public void Dispose()
    {
        DetenerTimerVisual();
        pollingTimer?.Stop();
        pollingTimer?.Dispose();
    }
}